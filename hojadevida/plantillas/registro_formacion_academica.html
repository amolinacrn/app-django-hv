{% extends "basehv.html" %}

{% load static %}
{% load crispy_forms_tags %}

{% block content_derecho%}

<script>

  function registroFormacionAcademica(
    condicional,
    id_diploma = '{{ id_actual }}',
    grado_academico,
    titulo_obtenido,
    institucion_universitaria,
    programa_academico,
    modalidad_academica,
    numero_targeta_profesional,
    graudado_universitario,
    titulo_disertacion,
    fecha_finalizacion,
    fecha_inicio,
    pais_titulo,
    departamento_titulo,
    ciudad_titulo,
    diploma_titulo
  ) {


    formacion_academica.innerHTML = "";

    registro_academico.innerHTML = `
        <div class="class_div" style="font-size:15px;border-top: rgb(8, 26, 66) 5px solid; border-radius: 10px;">
        {% if errform %}
        <div style="margin:0px; padding: 1px;background-color: rgb(255, 0, 0); width:63%; margin-left: 5cm;">
          <h5 style="color: white;margin-top:5px;">
            <b>&nbsp&nbsp
              No se ha podido enviar los datos, por favor revise el formulario
            </b>
          </h5>
        </div>
        <br>
        {% endif%}

        <table>
          <tr>
            <td width="3%">
              <img src="{% static 'bs532/img/imghv/fad.png' %}" style="width: 100%;transform: scale(0.8)" alt="My image">
            </td>
            <td width="1%">

            </td>
            <td style="font-size:15px;">
              <b class="text-uppercase">Registro formaci贸n acad茅mica</b>
            </td>
          </tr>
        </table>

        <hr>
        
        <form enctype="multipart/form-data" method="post" action="${id_diploma}">
          {% csrf_token %}
          <div class="card form-grid bg-light" style="margin-bottom:16px">
              {{form.grado_academico|as_crispy_field}}
              {{form.institucion_universitaria|as_crispy_field}}
              {{form.titulo_obtenido|as_crispy_field}}

              {{form.programa_academico|as_crispy_field}}
              {{form.modalidad_academica|as_crispy_field}}
              {{form.numero_targeta_profesional|as_crispy_field}}

              {{form.graudado_universitario|as_crispy_field}}
              {{form.fecha_inicio|as_crispy_field}}
              {{form.fecha_finalizacion|as_crispy_field}}

              {{form.pais_titulo|as_crispy_field}}
              {{form.departamento_titulo|as_crispy_field}}
              {{form.ciudad_titulo|as_crispy_field}}
          </div>

            <div class="card form-grid bg-light mb-3 p-3">

            <div class="full">
              {{form.titulo_disertacion|as_crispy_field}}
            </div>

            </div>

             <div class="card form-grid bg-light mb-3 p-3">

            <div class="full diploma-row">
              <div>
                {{form.diploma_titulo|as_crispy_field}}
                <div id="askdjfls" class="mensaje-archivo"></div>
              </div>

              <a id="ref_img_ver" onclick="funcionVisualizarModal('${diploma_titulo}')"
                style="width: 28px; cursor: pointer; margin-bottom: 7px;">

              </a>
            </div>
          </div>

          <br>
          <hr>


          <table width="100%">
            <tr>
              <td width="90%">
                <button class="btn btn-sm btn-outline-primary float-end" type="submit">
                  <b>Guardar</b>
                </button>
              </td>
              <td width="1%">
              </td>
              <td>

                <button onclick="FormacionAcademicaOK()" class="btn btn-outline-danger btn-sm ">
                  Cancelar
                </button>
                </a>
              </td>
            </tr>
          </table>
        </form>
      </div>
`;

    if (!condicional) return;

    const btn_ver_img = document.getElementById("ref_img_ver");
    btn_ver_img.innerHTML = ` <img src="{% static 'bs532/img/ver_violeta.svg' %}" style="width: 20px">`

    //  Mapeo autom谩tico de campos (misma l贸gica que t煤 usabas)
    const campos = {
      grado_academico,
      titulo_obtenido,
      institucion_universitaria,
      programa_academico,
      modalidad_academica,
      numero_targeta_profesional,
      graudado_universitario,
      titulo_disertacion,
      fecha_finalizacion,
      fecha_inicio,
      pais_titulo,
      departamento_titulo,
      ciudad_titulo
    };

    Object.entries(campos).forEach(([id, valor]) => {
      const input = document.getElementById(`id_${id}`);
      if (input) {
        input.value = valor ?? "";
        console.log(input)
      }
    });

    //  Mostrar nombre del diploma de forma segura
    if (diploma_titulo) {
      const nombreArchivo = diploma_titulo.split("/").pop();
      const label = document.getElementById("askdjfls");
      if (label) label.textContent = nombreArchivo;
    }
  }
  //Llama a la funci贸n al redimensionar la ventana

  function FormacionAcademicaOK() {
    registro_academico.innerHTML = ``
    formacion_academica.innerHTML = `
  <div class="class_div" style="font-size:15px;border-top: rgb(8, 26, 66) 5px solid; border-radius: 10px;">
    <table>
      <tr>
        <td width="3%">
          <img src="{% static 'bs532/img/imghv/fad.png' %}" style="width: 100%;transform: scale(0.8)" alt="My image">
        </td>
        <td width="1%">

        </td>
        <td style="font-size:15px;">
          <b class="text-uppercase">Formaci贸n acad茅mica</b>
        </td>
        <td style="font-size:15px;">
          <a href="{% url 'hojadevida' %}" class="btn btn-outline-danger float-end">
          
            <b>salir</b>
          </a>
        </td>

      </tr>
    </table>
      <br>
    <table width="100%">
      <tr>
        <td>
          <a class="btn btn-sm btn-outline-success float-end" onclick="registroFormacionAcademica()">
          Agregar formaci贸n
          </a>
        </td>
        <td width="10px"></td>
        <td width="35%">
          <div class="input-group mb-0">
              <span class="input-group-text" id="basic-addon1">buscar</span>
            <input type="text" class="form-control" placeholder="Buscar" aria-label="Username" aria-describedby="basic-addon1">
          </div>
        </td>
      </tr>
    </table>
    <div style="height:8px;width: 100%; background-color:rgba(255, 0, 0, 0) ;"></div>


<table class="competencias-table">
        <thead>
            <tr>
                <th> Grado academico</th>
                <th>Titulo</th>
                <th>Instituci贸n</th>
                <th>Periodo</th>
                <th>Pa铆s</th>
                <th>Modalidad</th>
                <th class="acciones-col">Opciones</th>
            </tr>
        </thead>

        <tbody>
            {% for qrdat in querydat %}
            <tr>
              <td>
                  {{ qrdat.grado_academico }}
                  </td>

                  <td >
                    {{ qrdat.titulo_obtenido }}
                  </td>

                  <td >
                    {{ qrdat.institucion_universitaria }}
                  </td>

                  <td >
                    {{qrdat.fecha_inicio|date:"d/m/Y" }} - {{qrdat.fecha_finalizacion|date:"d/m/Y" }}
                  </td>

                  <td >
                    {{ qrdat.pais_titulo }}
                  </td>

                  <td >
                    {{ qrdat.modalidad_academica }}
                  </td>

    

                <td class="acciones">
                    <!-- Ver soporte -->
                    <button type="button" class="icon-btn"
                        onclick="funcionVisualizarModal('{{ qrdat.diploma_titulo }}','T铆tulo acad茅mico')">
                        <img src="{% static 'bs532/img/ver_violeta.svg' %}" alt="Ver">
                    </button>

                    <!-- Editar -->
       
                <button type="button" class="editar-registro icon-btn" onclick="registroFormacionAcademica(
                  true,'{{ qrdat.id }}','{{ qrdat.grado_academico }}','{{ qrdat.titulo_obtenido }}','{{ qrdat.institucion_universitaria }}',
                  '{{ qrdat.programa_academico }}','{{ qrdat.modalidad_academica }}','{{ qrdat.numero_targeta_profesional }}',
                  '{{ qrdat.graudado_universitario }}', '{{ qrdat.titulo_disertacion }}','{{qrdat.fecha_finalizacion|date:"Y-m-d"}}', '{{ qrdat.fecha_inicio|date:"Y-m-d" }}'
                  ,'{{ qrdat.pais_titulo}}', '{{qrdat.departamento_titulo}}'
              , '{{qrdat.ciudad_titulo }}' ,'{{qrdat.diploma_titulo }}')" style="cursor:pointer">
             
                        <img src="{% static 'bs532/img/editar.svg' %}" alt="Editar">
                    </button>

                    <!-- Eliminar -->
                    <a href="{% url 'delete_file_record' 'TitulosAcademico' qrdat.id %}" class="icon-btn">
                        <img src="{% static 'bs532/img/eliminar.svg' %}" alt="Eliminar">
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

  </div>`;
  }
</script>

<div class="posicion_hv_html">
  <div id="registro_academico"></div>
  <div id="formacion_academica"></div>
</div>



{% if errform %}
<script>
  window.addEventListener("load", async () => {
    await registroFormacionAcademica();
  });

</script>
{% else %}
<script>
  const registro_academico = document.getElementById("registro_academico");
  const formacion_academica = document.getElementById("formacion_academica");
  window.addEventListener("load", async () => {
    await FormacionAcademicaOK();
  });
</script>
{% endif %}



{% endblock content_derecho %}